{% extends "base_generic.html" %}

{% block title %}
    <title>{{ user.get_username }} Dashboard</title>

    <style>
        .dashboardTotalBalance > div {
            width: 33%;
            padding: 0.5rem 1rem;
        }

        .dashboardTotalBalance > div:nth-of-type(n+2) {
            border-left: 2px solid hsl(0, 0%, 85%);
        }

        #chart-balance {
            width: 40rem !important;
            height: 20rem !important;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
    <div class="flexboxSB">
        <h1 class="textLarger">Portfolio Overview</h1>
        <p>September 3 2023</p>
    </div>

    <div class="flexboxSA grayBc5 marginB1 textLeft dashboardTotalBalance">
        <div>
            <h3 class="textNormal">Total Balance</h3>
            <p class="headingXl">${{ latest_balance_value }}</p>
        </div>

        <div>
            <h3 class="textNormal">30 Day Change</h3>
            <p class="headingXl">
                {% if change_seven_days < 0 %}
                    -${{ change_seven_days }}
                {% else %}
                    +${{ change_seven_days }}
                {% endif %}
            </p>
        </div>

        <div>
            <h3 class="textNormal">Cash</h3>
            <p class="headingXl">$200</p>
        </div>
    </div>
    
    <div>
        <table class="tableSmall textSmall">
            <caption>
                List of user assets
            </caption>

            <thead class="grayBc7 textRight">
                <tr>
                    <th scope="col">Icon</th>
                    <th class="textLeft" scope="col">Name</th>
                    <th scope="col">Price</th>
                    <th scope="col">Holdings</th>
                    <th scope="col">Value</th>
                </tr>
            </thead>

            <tbody>
                {% for balance in user_holdings_list %}
                    <tr class="grayBc9 textRight weight500">
                        <th scope="row">
                            <!--
                            {% load static %}
                            <img class='iconSmall' src="{% static balance.icon.url|slice:'18:' %}" />
                            -->
                        </th>
                        <th class="textLeft" scope="row">{{ balance.name }}</th>
                        <th scope="row">${{ balance.latest_price }}</th>
                        <th scope="row">{{ balance.latest_holding }}</th>
                        <th scope="row">${{ balance.latest_value }}</th>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!--
    <table>
        <caption>
            Portfolio value history
        </caption>

        <thead>
            <th scope="col">Date</th>
            <th scope="col">Value</th>
        </thead>

        <tbody>
            {% for total_balance in user_daily_balance_history %}
                <tr>
                    <th scope="row">{{ total_balance.date }}</th>
                    <th scope="row">{{ total_balance.values }}</th>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    -->
    <div>
        <canvas id="chart-balance"></canvas>
    </div>

    <script defer>
        let ctx = document.getElementById("chart-balance").getContext("2d");
        let daily_balance = JSON.parse('{{ user_daily_balance_history_json | safe }}');
        console.log(daily_balance)
        let chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: daily_balance.map(obj => obj.date),
                datasets: [
                    {
                        label: "Portfolio value",
                        data: daily_balance.map(obj => obj.values)
                    }
                ]
            },
            options: {
                responsive: false,
                mantainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
            }
        });
    </script>
{% endblock %}